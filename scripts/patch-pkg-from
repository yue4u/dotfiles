#!/usr/bin/env zx

// https://github.com/google/zx/issues/124#issuecomment-898469918
process.env.FORCE_COLOR = 3;
const local = await fs.readJSON("package.json");
const [url] = process.argv.slice(3);
console.log(chalk.yellow`patching from ${url}`);

const res = await fetch(url);
const remote = await res.json();

function patch(l, r) {
  Object.keys(l).forEach((key) => {
    const maybeNewVer = r[key];
    if (maybeNewVer) {
      l[key] = maybeNewVer;
    } else {
      l[`❌${key}`] = l[key];
      delete l[key];
    }
  });

  Object.keys(r).forEach((key) => {
    const exist = l[key];
    if (exist) return;
    l[`✅${key}`] = r[key];
  });
}

patch(local.dependencies, remote.dependencies);
patch(local.devDependencies, remote.devDependencies);

await fs.writeJSON("package.json", local, { space: 2 });
